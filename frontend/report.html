<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Laporan Wali Kelas | SAW DSS</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: "Poppins", sans-serif; }
  </style>
</head>

<body class="bg-gray-50">

  <div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-60 bg-white border-r hidden lg:block">
      <div class="p-6">
        <h1 class="text-xl font-bold text-gray-800 mb-8">SAW DSS</h1>

        <nav class="space-y-2">
          <a href="wali_dashboard.html" 
             class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Dashboard
          </a>

          <a href="wali_students.html" 
             class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Siswa Saya
          </a>

          <a href="wali_scores.html" 
             class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Penilaian
          </a>

          <a href="report.html" 
             class="block px-3 py-2 rounded-lg bg-indigo-100 text-indigo-600 font-medium">
            Laporan
          </a>

          <div class="pt-6 border-t mt-6">
            <button id="logoutBtn"
                    class="w-full text-left block px-3 py-2 rounded-lg text-red-600 hover:bg-red-50 font-medium">
              Logout
            </button>
          </div>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">

      <!-- Top bar -->
      <header class="bg-white border-b px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Laporan SAW Wali Kelas</h2>

        <div class="w-9 h-9 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold">
          WL
        </div>
      </header>

      <!-- Main area -->
      <main class="p-6">

        <div class="flex items-center justify-between mb-5">
          <h1 class="text-2xl font-bold text-gray-800">Preview Laporan Ranking</h1>

          <button id="btnCetakPDF"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow">
            Cetak PDF
          </button>
        </div>

        <!-- CARD Laporan -->
        <div id="hasilContainer" class="bg-white border rounded-xl p-6 shadow-sm">

          <div class="text-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800">Laporan Hasil Perhitungan SAW</h3>
            <p class="text-gray-500 text-sm">Wali Kelas</p>
            <p class="text-gray-500 text-sm">Tanggal: <span id="tanggalCetak"></span></p>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full border text-sm">
              <thead class="bg-gray-800 text-white text-center">
                <tr>
                  <th class="py-2 px-3 border">Ranking</th>
                  <th class="py-2 px-3 border">Nama Siswa</th>
                  <th class="py-2 px-3 border">Nilai Akhir (SAW)</th>
                </tr>
              </thead>
              <tbody id="tbodyHasil" class="text-center bg-white"></tbody>
            </table>
          </div>

          <!-- Signature -->
          <div class="mt-12 flex justify-end pr-20">
            <div class="text-center">
              <p class="mb-1">Mengetahui,</p>
              <p class="font-semibold">Kepala Sekolah</p>
              <div style="height: 80px;"></div>
              <p class="font-semibold underline">(_______________________)</p>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

<script>
const token = localStorage.getItem("token");

// Load Tanggal
document.getElementById("tanggalCetak").textContent =
  new Date().toLocaleDateString("id-ID");

// Logout
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("token");
  localStorage.removeItem("username");
  window.location.href = "login.html";
};

// Load data laporan SAW
async function loadHasil() {
  const tbody = document.getElementById("tbodyHasil");

  try {
    const res = await fetch("http://localhost:4000/report/walikelas/data", {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) {
      tbody.innerHTML = `
        <tr><td colspan="3" class="py-4 text-red-500">Gagal memuat data.</td></tr>
      `;
      return;
    }

    const text = await (await res.blob()).text();
    const data = JSON.parse(text);

    if (!data.length) {
      tbody.innerHTML = `
        <tr><td colspan="3" class="py-4 text-gray-500">Belum ada data.</td></tr>
      `;
      return;
    }

    tbody.innerHTML = data.map((item, i) => `
      <tr class="border hover:bg-gray-50">
        <td class="py-2 px-3 border font-semibold">${i + 1}</td>
        <td class="py-2 px-3 border">${item.student_name}</td>
        <td class="py-2 px-3 border">${item.total.toFixed(4)}</td>
      </tr>
    `).join("");

  } catch (err) {
    console.error(err);
  }
}

loadHasil();

// Cetak PDF
document.getElementById("btnCetakPDF").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "a4");
  const area = document.getElementById("hasilContainer");

  const canvas = await html2canvas(area, { scale: 2 });
  const img = canvas.toDataURL("image/png");

  const width = pdf.internal.pageSize.getWidth() - 40;
  const height = (canvas.height * width) / canvas.width;

  pdf.addImage(img, "PNG", 20, 20, width, height);
  pdf.save("Laporan_Wali_Kelas_SAW.pdf");
});
</script>

</body>
</html>
