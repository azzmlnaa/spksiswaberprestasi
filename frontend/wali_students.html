<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wali Kelas â€“ Data Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Poppins", sans-serif; }
  </style>
</head>

<body class="bg-gray-50">

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-60 bg-white border-r hidden lg:block">
      <div class="p-6">
        <h1 class="text-xl font-bold text-gray-800 mb-8">SAW DSS</h1>
        <nav class="space-y-2">
          <a href="wali_dashboard.html" class="block px-3 py-2">Dashboard</a>
          <a class="block px-3 py-2 bg-indigo-100 text-indigo-600 rounded-lg font-medium">
            Siswa Saya
          </a>
           <a href="wali_scores.html" class="block px-3 py-2">Penilaian</a>
            <a href="report.html" class="block px-3 py-2">Laporan</a>
          
          <a id="logoutBtnSidebar" href="index.html" class="block px-3 py-2 text-red-600">Logout</a>
        </nav>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">

      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Data Siswa</h1>
          <p class="text-gray-500 text-sm">Wali kelas hanya boleh mengelola siswa di kelasnya</p>
        </div>

        <button onclick="openAddModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
          + Tambah Siswa
        </button>
      </div>

      <!-- Table -->
      <div class="bg-white border p-4 rounded-xl shadow">
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">#</th>
                <th class="px-4 py-2 text-left">Nama</th>
                <th class="px-4 py-2 text-left">NIS</th>
                <th class="px-4 py-2 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <p id="noData" class="text-center text-gray-500 mt-4 hidden">Tidak ada siswa.</p>
      </div>

    </main>
  </div>

  <!-- Add Modal -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white p-6 w-96 rounded-xl">
      <h2 class="text-lg font-bold mb-4">Tambah Siswa</h2>

      <form id="addForm">
        <label>Nama</label>
        <input id="addName" class="w-full border p-2 rounded mb-3" required>

        <label>NIS</label>
        <input id="addNis" class="w-full border p-2 rounded mb-4" required>

        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddModal()" class="px-4 py-2 bg-gray-200 rounded">Batal</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white p-6 w-96 rounded-xl">
      <h2 class="text-lg font-bold mb-4">Edit Siswa</h2>

      <form id="editForm">
        <input type="hidden" id="editId">

        <label>Nama</label>
        <input id="editName" class="w-full border p-2 rounded mb-3" required>

        <label>NIS</label>
        <input id="editNis" class="w-full border p-2 rounded mb-4" required>

        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 rounded">Batal</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Update</button>
        </div>
      </form>
    </div>
  </div>

<script>
  const API = "http://localhost:4000/api/wali/students";
  const token = localStorage.getItem("token");

  if (!token) {
    alert("Anda harus login sebagai wali kelas!");
    window.location.href = "index.html";
  }

  // ================================
  // LOAD STUDENTS
  // ================================
  async function loadStudents() {
    const res = await fetch(API, {
      headers: { Authorization: "Bearer " + token }
    });

    const json = await res.json();
    const data = json.data || [];

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (data.length === 0) {
      document.getElementById("noData").classList.remove("hidden");
      return;
    }

    document.getElementById("noData").classList.add("hidden");

    data.forEach((s, i) => {
      tbody.innerHTML += `
        <tr class="border-t">
          <td class="px-4 py-2">${i + 1}</td>
          <td class="px-4 py-2">${s.name}</td>
          <td class="px-4 py-2">${s.nis}</td>
          <td class="px-4 py-2">
            <button onclick="openEditModal(${s.id}, '${s.name}', '${s.nis}')" class="text-blue-600">Edit</button>
            <button onclick="deleteStudent(${s.id})" class="text-red-600 ml-2">Hapus</button>
          </td>
        </tr>
      `;
    });
  }

  loadStudents();

  // ================================
  // ADD STUDENT
  // ================================
  function openAddModal() {
    document.getElementById("addModal").classList.remove("hidden");
  }
  function closeAddModal() {
    document.getElementById("addModal").classList.add("hidden");
  }

  document.getElementById("addForm").onsubmit = async (e) => {
    e.preventDefault();

    const body = {
      name: document.getElementById("addName").value,
      nis: document.getElementById("addNis").value,
    };

    await fetch(API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify(body)
    });

    closeAddModal();
    loadStudents();
  };

  // ================================
  // EDIT STUDENT
  // ================================
  function openEditModal(id, name, nis) {
    document.getElementById("editId").value = id;
    document.getElementById("editName").value = name;
    document.getElementById("editNis").value = nis;
    document.getElementById("editModal").classList.remove("hidden");
  }

  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
  }

  document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();

    const id = document.getElementById("editId").value;

    const body = {
      name: document.getElementById("editName").value,
      nis: document.getElementById("editNis").value,
    };

    await fetch(`${API}/${id}`, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify(body)
    });

    closeEditModal();
    loadStudents();
  };

  // ================================
  // DELETE STUDENT
  // ================================
  async function deleteStudent(id) {
    if (!confirm("Hapus siswa ini?")) return;

    await fetch(`${API}/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    });

    loadStudents();
  }
</script>

</body>
</html>
