<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Students</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Poppins", sans-serif; }
  </style>
</head>

<body class="bg-gray-50">

  <div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-60 bg-white border-r hidden lg:block">
      <div class="p-6">
        <h1 class="text-xl font-bold text-gray-800 mb-8">SAW DSS</h1>

        <nav class="space-y-2">
          <a href="dashboard.html" class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Dashboard
          </a>
          <a href="students.html" class="block px-3 py-2 rounded-lg bg-indigo-100 text-indigo-600 font-medium">
            Students
          </a>
          <a href="kriteria.html" class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Criteria
          </a>
          <a href="scores.html" class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Scores
          </a>
          <a href="walikelas.html" class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            User
          </a>
          <a href="kelas.html" class="block px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
            Kelas
          </a>

          <div class="pt-6 border-t mt-6">
            <a id="logoutBtnSidebar" href="index.html" class="block px-3 py-2 rounded-lg text-red-600 hover:bg-red-50 font-medium">
              Logout
            </a>
          </div>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">

      <!-- Top bar -->
      <header class="bg-white border-b px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Students</h2>

        <div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold">
            AD
          </div>
        </div>
      </header>

      <!-- Page content -->
      <main class="p-6">

        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Data Students</h1>
            <p class="text-gray-500 text-sm">Kelola data siswa (CRUD, filter, search, export)</p>
          </div>

          <button onclick="openAdd()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
            + Tambah Siswa
          </button>
        </div>

        <!-- Tools -->
        <div class="bg-white border rounded-xl p-4 mb-4 flex flex-wrap gap-4 items-center">
          <input
            id="searchInput"
            type="search"
            placeholder="Cari nama atau NIS..."
            class="border p-2 rounded w-64"
            oninput="applyFilters()"
          />

          <select id="classFilter" class="border p-2 rounded" onchange="applyFilters()">
            <option value="">Semua Kelas</option>
          </select>

          <button onclick="loadStudents(true)"
                  class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
            Refresh
          </button>

          <button onclick="exportPDF()"
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            Export PDF
          </button>
        </div>

        <!-- Table -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-200 rounded-lg">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">#</th>
                  <th class="px-4 py-2 text-left">Nama</th>
                  <th class="px-4 py-2 text-left">NIS</th>
                  <th class="px-4 py-2 text-left">Kelas</th>
                  <th class="px-4 py-2 text-left">Wali Kelas</th>
                  <th class="px-4 py-2 text-left">Aksi</th>
                </tr>
              </thead>
              <tbody id="studentsTable"></tbody>
            </table>
          </div>

          <p id="noData" class="text-center text-gray-500 mt-4 hidden">Tidak ada data siswa.</p>
        </div>

      </main>
    </div>
  </div>

  <!-- Modal-Modals (Add + Edit) -->
  <!-- SAME as your previous modal code, tinggal ditempel -->
  <!-- Kalau mau aku rapikan biar senada juga, tinggal bilang ya -->

  <script>
  const API = "http://localhost:4000/students/admin";

  let students = [];
  let filtered = [];

  // ===================================
  // LOAD DATA DARI BACKEND
  // ===================================
  async function loadStudents(showAlert = false) {
    try {
      const res = await fetch(API, {
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("token")
        }
      });

      const json = await res.json();

      if (json.status !== "success") throw new Error(json.message);

      students = json.data;
      filtered = students;

      renderTable();
      fillClassFilter();

      if (showAlert) alert("Data berhasil diperbarui!");

    } catch (err) {
      console.error(err);
      alert("Gagal memuat data siswa!");
    }
  }

  // ===================================
  // RENDER TABLE
  // ===================================
  function renderTable() {
    const tbody = document.getElementById("studentsTable");
    const noData = document.getElementById("noData");

    tbody.innerHTML = "";

    if (filtered.length === 0) {
      noData.classList.remove("hidden");
      return;
    }

    noData.classList.add("hidden");

    filtered.forEach((s, i) => {
      tbody.innerHTML += `
        <tr class="border-t">
          <td class="px-4 py-2">${i + 1}</td>
          <td class="px-4 py-2">${s.name}</td>
          <td class="px-4 py-2">${s.nis}</td>
          <td class="px-4 py-2">${s.class_name || "-"}</td>
          <td class="px-4 py-2">${s.wali || "-"}</td>

          <td class="px-4 py-2">
            <button onclick="openEdit(${s.id})"
              class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Edit</button>

            <button onclick="deleteStudent(${s.id})"
              class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Hapus</button>
          </td>
        </tr>
      `;
    });
  }

  // ===================================
  // FILTER + SEARCH
  // ===================================
  function applyFilters() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const classId = document.getElementById("classFilter").value;

    filtered = students.filter(s => {
      const matchName = s.name.toLowerCase().includes(search);
      const matchNis = s.nis.toLowerCase().includes(search);
      const matchClass = classId === "" || s.class_id == classId;

      return (matchName || matchNis) && matchClass;
    });

    renderTable();
  }

  // ===================================
  // CLASS FILTER OPTION
  // ===================================
  function fillClassFilter() {
    const select = document.getElementById("classFilter");
    const classList = [...new Set(students.map(s => `${s.class_id}|${s.class_name}`))];

    select.innerHTML = `<option value="">Semua Kelas</option>`;

    classList.forEach(cls => {
      const [id, name] = cls.split("|");
      select.innerHTML += `<option value="${id}">${name}</option>`;
    });
  }

  // ===================================
  // TAMBAH DATA
  // ===================================
  function openAdd() {
    const name = prompt("Nama siswa:");
    const nis = prompt("NIS:");
    const classId = prompt("Class ID (angka):");

    if (!name || !nis || !classId) return alert("Semua field wajib diisi!");

    fetch(API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify({ name, nis, class_id: classId })
    })
      .then(res => res.json())
      .then(json => {
        alert(json.message);
        loadStudents();
      });
  }

  // ===================================
  // EDIT DATA
  // ===================================
  function openEdit(id) {
    const s = students.find(x => x.id === id);

    const name = prompt("Nama baru:", s.name);
    const nis = prompt("NIS baru:", s.nis);
    const classId = prompt("Class ID baru:", s.class_id);

    fetch(`${API}/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
      },
      body: JSON.stringify({ name, nis, class_id: classId })
    })
      .then(res => res.json())
      .then(json => {
        alert(json.message);
        loadStudents();
      });
  }

  // ===================================
  // HAPUS DATA
  // ===================================
  function deleteStudent(id) {
    if (!confirm("Yakin ingin menghapus siswa ini?")) return;

    fetch(`${API}/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("token")
      }
    })
      .then(res => res.json())
      .then(json => {
        alert(json.message);
        loadStudents();
      });
  }

  // ===================================
  // EXPORT PDF (Dummy)
  // ===================================
  function exportPDF() {
    alert("Fitur export PDF akan dihubungkan backend.");
  }

  // Jalankan load data saat halaman dibuka
  loadStudents();
</script>


</body>
</html>
