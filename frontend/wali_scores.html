<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wali Kelas – Nilai Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Poppins", sans-serif; }
  </style>
</head>

<body class="bg-gray-50">

<div class="flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-60 bg-white border-r hidden lg:block">
    <div class="p-6">
      <h1 class="text-xl font-bold text-gray-800 mb-8">SAW DSS</h1>
      <nav class="space-y-2">
        <a href="wali_dashboard.html" class="block px-3 py-2 rounded-lg hover:bg-gray-100">Dashboard</a>
        <a href="wali_siswa.html" class="block px-3 py-2 rounded-lg hover:bg-gray-100">Siswa</a>
        <a href="wali_scores.html" class="block px-3 py-2 rounded-lg bg-indigo-100 text-indigo-600 font-medium">Nilai Siswa</a>
        <div class="pt-6 border-t mt-6">
          <a href="index.html" class="block px-3 py-2 rounded-lg text-red-600 hover:bg-red-50 font-medium">Logout</a>
        </div>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <div class="flex-1 flex flex-col">

    <!-- Top bar -->
    <header class="bg-white border-b px-6 py-4 flex items-center justify-between">
      <h2 class="text-xl font-semibold text-gray-800">Nilai Siswa</h2>
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold">WL</div>
      </div>
    </header>

    <!-- Content -->
    <main class="p-6">

      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Manajemen Nilai</h1>
          <p class="text-gray-500 text-sm">Kelola nilai siswa berdasarkan kriteria</p>
        </div>
        <button onclick="openAddModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">+ Tambah Nilai</button>
      </div>

      <!-- Table -->
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left">Nama Siswa</th>
                <th class="px-4 py-2 text-left">NIS</th>
                <th class="px-4 py-2 text-left">Kriteria</th>
                <th class="px-4 py-2 text-left">Nilai</th>
                <th class="px-4 py-2 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="scoreTable"></tbody>
          </table>
        </div>

        <p id="noData" class="text-center text-gray-500 mt-4 hidden">Tidak ada nilai siswa.</p>
      </div>

    </main>

  </div>
</div>

<!-- ADD MODAL -->
<div id="addModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow p-6 w-96">
    <h2 class="text-lg font-semibold mb-3">Tambah Nilai</h2>

    <label class="text-sm">Siswa</label>
    <select id="addStudent" class="border p-2 rounded w-full mb-3"></select>

    <label class="text-sm">Kriteria</label>
    <select id="addCriteria" class="border p-2 rounded w-full mb-3"></select>

    <label class="text-sm">Nilai</label>
    <input id="addValue" type="number" class="border p-2 rounded w-full mb-4" min="0">

    <div class="flex justify-end gap-2">
      <button onclick="closeAddModal()" class="px-3 py-1 rounded bg-gray-400 text-white">Batal</button>
      <button onclick="saveAdd()" class="px-3 py-1 rounded bg-green-600 text-white">Simpan</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow p-6 w-96">
    <h2 class="text-lg font-semibold mb-3">Edit Nilai</h2>

    <input type="hidden" id="editId">

    <label class="text-sm">Nilai</label>
    <input id="editValue" type="number" class="border p-2 rounded w-full mb-4" min="0">

    <div class="flex justify-end gap-2">
      <button onclick="closeEditModal()" class="px-3 py-1 rounded bg-gray-400 text-white">Batal</button>
      <button onclick="saveEdit()" class="px-3 py-1 rounded bg-blue-600 text-white">Update</button>
    </div>
  </div>
</div>

<script>
/*
  Perbaikan frontend:
  - Tahan respons API yang bentuknya json.data atau langsung json
  - Gunakan nama kolom sesuai DB: students.name, students.nis, criteria.name, scores.score
  - Pakai token untuk fetch criteria & students supaya dropdown tersedia
*/

const API = "http://localhost:4000/api/wali/scores";
const API_STUDENTS = "http://localhost:4000/api/wali/students";
const API_CRITERIA = "http://localhost:4000/api/criteria";
const token = localStorage.getItem("token");

if (!token) {
  // kalau belum login, arahkan ke login
  // window.location.href = "index.html";
  console.warn("Token not found in localStorage. Some endpoints may require auth.");
}

// helper untuk mengekstrak daftar dari respons fleksibel
function getListFromResponse(json) {
  if (!json) return [];
  if (Array.isArray(json)) return json;
  if (Array.isArray(json.data)) return json.data;
  // sometimes API returns { data: { rows: [...] } } — add more if needed
  return json.data || json.result || [];
}

// =============================
// LOAD SCORE TABLE
// =============================
async function loadData() {
  try {
    const res = await fetch(API, { headers: { Authorization: "Bearer " + token }});
    const json = await res.json();

    const rows = getListFromResponse(json);
    const table = document.getElementById("scoreTable");
    const noData = document.getElementById("noData");

    table.innerHTML = "";

    if (!rows || rows.length === 0) {
      noData.classList.remove("hidden");
      return;
    }

    noData.classList.add("hidden");

    rows.forEach(item => {
      // dukung beberapa variasi alias yang mungkin dikirim server
      const studentName = item.student_name || item.name || item.student || "";
      const nis = item.nis || item.student_nis || "";
      const criteriaName = item.criteria_name || (item.criteria && (item.criteria.name || item.criteria_name)) || item.criteria_name || item.name_criteria || "";
      const scoreValue = item.score ?? item.value ?? item.score_value ?? "";

      table.innerHTML += `
        <tr>
          <td class="px-4 py-2">${escapeHtml(studentName)}</td>
          <td class="px-4 py-2">${escapeHtml(nis)}</td>
          <td class="px-4 py-2">${escapeHtml(criteriaName)}</td>
          <td class="px-4 py-2">${escapeHtml(String(scoreValue))}</td>
          <td class="px-4 py-2">
            <button onclick="openEditModal('${item.id ?? item.score_id ?? item.scoreId}', '${scoreValue}')"
              class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</button>
            <button onclick="deleteScore('${item.id ?? item.score_id ?? item.scoreId}')"
              class="px-2 py-1 bg-red-600 text-white rounded">Hapus</button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("LOAD ERROR:", err);
    document.getElementById("scoreTable").innerHTML = `<tr><td colspan="5" class="p-4 text-red-600">Gagal memuat data: ${escapeHtml(err.message || err)}</td></tr>`;
  }
}

// =============================
// LOAD STUDENTS & CRITERIA
// =============================
async function loadStudents() {
  try {
    const res = await fetch(API_STUDENTS, { headers: { Authorization: "Bearer " + token }});
    const json = await res.json();
    const list = getListFromResponse(json);

    const select = document.getElementById("addStudent");
    select.innerHTML = "";

    list.forEach(s => {
      const id = s.id ?? s.student_id ?? "";
      const name = s.name ?? s.student_name ?? "";
      const nis = s.nis ?? "";
      select.innerHTML += `<option value="${id}">${escapeHtml(name)} (${escapeHtml(nis)})</option>`;
    });
  } catch (err) {
    console.error("LOAD STUDENTS ERROR:", err);
    document.getElementById("addStudent").innerHTML = `<option value="">(gagal memuat siswa)</option>`;
  }
}

async function loadCriteria() {
  try {
    // sertakan token — beberapa endpoint kriteria butuh auth di backend
    const headers = token ? { Authorization: "Bearer " + token } : {};
    headers["Content-Type"] = "application/json";
    const res = await fetch(API_CRITERIA, { headers });
    const json = await res.json();
    const list = getListFromResponse(json);

    const select = document.getElementById("addCriteria");
    select.innerHTML = "";

    list.forEach(c => {
      const id = c.id ?? "";
      const name = c.name ?? c.criteria_name ?? c.title ?? "";
      select.innerHTML += `<option value="${id}">${escapeHtml(name)}</option>`;
    });

    if (list.length === 0) {
      select.innerHTML = `<option value="">(tidak ada kriteria)</option>`;
    }
  } catch (err) {
    console.error("LOAD CRITERIA ERROR:", err);
    document.getElementById("addCriteria").innerHTML = `<option value="">(gagal memuat kriteria)</option>`;
  }
}

// =============================
// MODAL & CRUD
// =============================
function openAddModal() {
  loadStudents();
  loadCriteria();
  document.getElementById("addModal").classList.add("flex");
  document.getElementById("addModal").classList.remove("hidden");
}

function closeAddModal() {
  document.getElementById("addModal").classList.add("hidden");
  document.getElementById("addModal").classList.remove("flex");
}

async function saveAdd() {
  const student_id = document.getElementById("addStudent").value;
  const criteria_id = document.getElementById("addCriteria").value;
  const value = document.getElementById("addValue").value;

  if (!student_id || !criteria_id) {
    return alert("Pilih siswa dan kriteria terlebih dahulu.");
  }

  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({ student_id, criteria_id, score: value }) // kirim sebagai 'score' sesuai DB
    });
    const j = await res.json();
    if (!res.ok) throw new Error(j.message || 'Gagal menambah');
    closeAddModal();
    await loadData();
  } catch (err) {
    alert("Gagal menambah nilai: " + (err.message || err));
  }
}

function openEditModal(id, value) {
  document.getElementById("editId").value = id;
  document.getElementById("editValue").value = value;
  document.getElementById("editModal").classList.add("flex");
  document.getElementById("editModal").classList.remove("hidden");
}

function closeEditModal() {
  document.getElementById("editModal").classList.add("hidden");
  document.getElementById("editModal").classList.remove("flex");
}

async function saveEdit() {
  const id = document.getElementById("editId").value;
  const value = document.getElementById("editValue").value;

  if (!id) return alert("ID tidak ditemukan.");

  try {
    const res = await fetch(`${API}/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({ score: value }) // gunakan 'score' supaya sinkron dengan DB
    });
    const j = await res.json();
    if (!res.ok) throw new Error(j.message || 'Gagal update');
    closeEditModal();
    await loadData();
  } catch (err) {
    alert("Gagal update nilai: " + (err.message || err));
  }
}

async function deleteScore(id) {
  if (!confirm("Hapus nilai ini?")) return;
  try {
    const res = await fetch(`${API}/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    });
    const j = await res.json();
    if (!res.ok) throw new Error(j.message || 'Gagal hapus');
    await loadData();
  } catch (err) {
    alert("Gagal hapus nilai: " + (err.message || err));
  }
}

// small helper to avoid XSS via string interpolation
function escapeHtml(str) {
  if (str == null) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// init
loadData();
</script>

</body>
</html>
